import React, { useState, useEffect } from 'react';

const TruthfulnessGauge = () => {
  const [value, setValue] = useState(30);
  const [animating, setAnimating] = useState(false);
  const [gaugeText, setGaugeText] = useState("");

  // Gauge configuration
  const min = 0;
  const max = 100;
  const radius = 120;
  const strokeWidth = 30;
  const startAngle = 180;
  const endAngle = 0;

  // Center of our gauge
  const centerX = radius + strokeWidth;
  const centerY = radius + strokeWidth;

  // SVG viewBox size
  const viewBoxWidth = (radius + strokeWidth) * 2;
  const viewBoxHeight = radius + strokeWidth * 2;

  // Map a value [0..100] → angle [180..0]
  const valueToAngle = (v) =>
    startAngle - ((v - min) / (max - min)) * (startAngle - endAngle);

  // New: a simpler set of colored segments, left→right: green → yellow → orange → red
  const segments = [
    { start: 0,   end: 20,  color: "#00FF00" },
    { start: 20,  end: 40,  color: "#FFFF00" },
    { start: 40,  end: 60,  color: "#FFA500" },
    { start: 60,  end: 80,  color: "#FF4500" },
    { start: 80,  end: 100, color: "#FF0000" },
  ];

  const generateSegments = () =>
    segments.map(({ start, end, color }, i) => {
      const a1 = (valueToAngle(start) * Math.PI) / 180;
      const a2 = (valueToAngle(end) * Math.PI) / 180;

      const x1 = centerX + radius * Math.cos(a1);
      const y1 = centerY - radius * Math.sin(a1);
      const x2 = centerX + radius * Math.cos(a2);
      const y2 = centerY - radius * Math.sin(a2);

      // Always < 180° arcs here
      const largeArcFlag = 0;
      // Sweep clockwise
      const sweepFlag = 1;

      const d = `M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} ${sweepFlag} ${x2} ${y2}`;

      return (
        <path
          key={i}
          d={d}
          fill="none"
          stroke={color}
          strokeWidth={strokeWidth}
          strokeLinecap="butt"
        />
      );
    });

  // Text labels & colors
  const levels = [
    { min: 0,  max: 20,  text: "COMPLETE BULLSHIT", color: "#FF0000" },
    { min: 20, max: 40,  text: "MOSTLY FALSE",     color: "#FF4500" },
    { min: 40, max: 60,  text: "QUESTIONABLE",     color: "#FFA500" },
    { min: 60, max: 80,  text: "MOSTLY TRUE",      color: "#FFFF00" },
    { min: 80, max: 100, text: "FACTUAL",          color: "#00FF00" },
    { min: 100, max: 101,text: "ABSOLUTE TRUTH",   color: "#00FF00" },
  ];

  useEffect(() => {
    for (let lvl of levels) {
      if (value >= lvl.min && value < lvl.max) {
        setGaugeText(lvl.text);
        break;
      }
    }
  }, [value]);

  // Animate needle if requested
  useEffect(() => {
    if (!animating) return;
    const iv = setInterval(() => {
      setValue((v) => (v >= max ? min : v + 1));
    }, 50);
    return () => clearInterval(iv);
  }, [animating]);

  const generateRandomScore = () =>
    setValue(Math.floor(Math.random() * 101));

  // Compute the current angle
  const angle = valueToAngle(value);

  return (
    <div className="flex flex-col items-center bg-white p-8 rounded-lg">
      <h1 className="text-2xl font-bold text-gray-800 mb-6">
        Truthfulness Gauge
      </h1>

      <svg
        viewBox={`0 0 ${viewBoxWidth} ${viewBoxHeight}`}
        width="300"
        height="160"
        className="mb-2"
      >
        {generateSegments()}

        {/* Needle as a line, rotated around the center */}
        <line
          x1={centerX}
          y1={centerY}
          x2={centerX}
          y2={centerY - (radius - 10)}
          stroke="black"
          strokeWidth="4"
          strokeLinecap="round"
          transform={`rotate(${angle} ${centerX} ${centerY})`}
          style={{ transition: "transform 0.3s ease-out" }}
        />

        {/* Center pivot */}
        <circle cx={centerX} cy={centerY} r="6" fill="black" />
      </svg>

      <div className="text-xl font-bold mb-1" style={{ color: levels.find(l => value >= l.min && value < l.max)?.color }}>
        {gaugeText}
      </div>
      <div className="text-3xl font-bold mb-4" style={{ color: levels.find(l => value >= l.min && value < l.max)?.color }}>
        {Math.round(value)}%
      </div>

      <div className="flex gap-4 mb-4">
        <button
          onClick={generateRandomScore}
          className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition"
        >
          Random
        </button>
        <button
          onClick={() => setAnimating(!animating)}
          className="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition"
        >
          {animating ? "Stop" : "Animate"}
        </button>
      </div>

      <input
        type="range"
        min={min}
        max={max}
        value={value}
        onChange={(e) => setValue(+e.target.value)}
        disabled={animating}
        className="w-64"
      />
    </div>
  );
};

export default TruthfulnessGauge;
