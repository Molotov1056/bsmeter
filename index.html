<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Truthfulness Gauge</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: white;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      height: 100vh;
    }
    .gauge-container {
      position: relative;
      width: 100%;
      max-width: 320px;
      aspect-ratio: 2 / 1;
      overflow: hidden;
    }
    .gauge-arc {
      width: 100%;
      height: 200%;
      background: conic-gradient(
        #27ae60 0% 20%,
        #2ecc71 20% 40%,
        #f1c40f 40% 60%,
        #e67e22 60% 80%,
        #e74c3c 80% 100%
      );
      border-radius: 50%;
      position: absolute;
      top: 0;
      left: 0;
    }
    .gauge-cover {
      width: 60%;
      height: 60%;
      background: white;
      border-radius: 50%;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
    }
    .needle {
      width: 4px;
      height: 50%;
      background: black;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform-origin: bottom center;
      transform: rotate(-90deg);
      transition: transform 1s ease-out;
      z-index: 3;
    }
    .labels {
      width: 100%;
      max-width: 320px;
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-weight: bold;
    }
    .score {
      font-size: 2em;
      margin-top: 16px;
    }
    .description {
      font-size: 1.2em;
      margin-bottom: 16px;
    }
    .buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 16px;
      font-size: 1em;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:active {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="gauge-container">
    <div class="gauge-arc"></div>
    <div class="needle" id="needle"></div>
    <div class="gauge-cover"></div>
  </div>

  <div class="labels">
    <span>BULLSHIT</span>
    <span>TRUE</span>
  </div>

  <div class="score" id="score">--%</div>
  <div class="description" id="description">Loading...</div>

  <div class="buttons">
    <button id="randomBtn">Generate Random Score</button>
    <button id="closeBtn">Close</button>
  </div>

  <script>
    (()=>{
      const needle = document.getElementById('needle');
      const scoreText = document.getElementById('score');
      const description = document.getElementById('description');

      const getDescription = (val) => {
        if (val < 20) return "COMPLETE BULLSHIT";
        if (val < 40) return "QUESTIONABLE";
        if (val < 60) return "MIXED";
        if (val < 80) return "FACTUAL";
        return "ABSOLUTE TRUTH";
      };

      const setGauge = (val, animate = true) => {
        const angle = (val * 1.8) - 90; // maps 0–100 → -90 to +90
        needle.style.transition = animate ? 'transform 1s ease-out' : 'none';
        needle.style.transform = `rotate(${angle}deg)`;
        scoreText.textContent = `${val}%`;
        description.textContent = getDescription(val);
        console.log("Set score:", val);
        if (window.Telegram?.WebApp?.sendData) {
          Telegram.WebApp.sendData(JSON.stringify({ score: val }));
          console.log("Sent to bot:", val);
        } else {
          console.warn("Telegram WebApp API not available");
        }
      };

      const getInitialScore = () => {
        const params = new URLSearchParams(location.search);
        const raw = params.get("score");
        const val = parseInt(raw, 10);
        if (!isNaN(val) && val >= 0 && val <= 100) {
          return val;
        }
        const rand = Math.floor(Math.random() * 101);
        console.log("Invalid or missing score, using random:", rand);
        return rand;
      };

      document.getElementById('randomBtn').addEventListener('click', () => {
        const val = Math.floor(Math.random() * 101);
        setGauge(val);
      });

      document.getElementById('closeBtn').addEventListener('click', () => {
        if (window.Telegram?.WebApp?.close) {
          Telegram.WebApp.close();
        } else {
          console.warn("Telegram WebApp API not available for close");
        }
      });

      // Init
      if (window.Telegram?.WebApp?.ready) {
        Telegram.WebApp.ready();
      }
      setGauge(getInitialScore(), false);
    })();
  </script>
</body>
</html>
